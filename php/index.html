<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º (RAG) ‚Äî –∫–∞—Ä–∫–∞—Å –¥–ª—è –≤—ë—Ä—Å—Ç–∫–∏</title>
    <!-- –°—é–¥–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ—Ä –ø–æ–¥–∫–ª—é—á–∏—Ç —Å–≤–æ–∏ —Å—Ç–∏–ª–∏ -->
</head>
<body>
    <!-- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è –¥–ª—è —Ä–∞–±–æ—Ç—ã JS.
         –í—Å–µ id –æ—Å—Ç–∞–≤–ª–µ–Ω—ã, –∫–ª–∞—Å—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
         —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö (—Å–º. renderResults) –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–º–µ–Ω–µ–Ω—ã. -->
    <div class="container">
        <h1>üîç –ü–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º</h1>
        <div class="search-form">
            <input type="text" id="queryInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..." autofocus>
            <button type="submit" id="searchBtn">–ü–æ–∏—Å–∫</button>
        </div>
        <div class="results" id="resultsContainer">
            <!-- –°—é–¥–∞ JS –±—É–¥–µ—Ç –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        </div>
    </div>

    <script>
        const searchBtn = document.getElementById('searchBtn');
        const queryInput = document.getElementById('queryInput');
        const resultsContainer = document.getElementById('resultsContainer');

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–µ–∑–∫–∏ —Ç–µ–∫—Å—Ç–∞
        function truncateText(text, maxLength = 200) {
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength) + '‚Ä¶';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å XSS)
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function renderResults(data, query) {
            if (!query.trim()) {
                resultsContainer.innerHTML = '<div class="no-results">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ –ø–æ–ª–µ –≤—ã—à–µ</div>';
                return;
            }

            if (!Array.isArray(data) || data.length === 0) {
                resultsContainer.innerHTML = `<div class="no-results">–ü–æ –∑–∞–ø—Ä–æ—Å—É ¬´${escapeHtml(query)}¬ª –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
                return;
            }

            const stats = `<div class="stats">–ù–∞–π–¥–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${data.length}</div>`;

            const items = data.map(item => {
                const text = escapeHtml(item.text || '');
                const source = escapeHtml(item.source || '–¥–æ–∫—É–º–µ–Ω—Ç');
                const score = item.score ? item.score.toFixed(3) : '?';
                const fileUrl = `/documents/${encodeURIComponent(source)}`;
                const fileName = source;
                const snippet = truncateText(text, 200);

                return `
                    <div class="result-item">
                        <h3><a href="${fileUrl}" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª">${fileName}</a></h3>
                        <div class="source">${fileUrl}</div>
                        <div class="snippet">${snippet}</div>
                        <div class="score">–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${score}</div>
                    </div>
                `;
            }).join('');

            resultsContainer.innerHTML = stats + items;
        }

        function showError(message) {
            resultsContainer.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
        }

        function setLoading(isLoading) {
            if (isLoading) {
                searchBtn.disabled = true;
                searchBtn.innerHTML = '–ü–æ–∏—Å–∫ <span class="loader"></span>';
            } else {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '–ü–æ–∏—Å–∫';
            }
        }

        async function search(query) {
            if (!query.trim()) {
                renderResults([], query);
                return;
            }

            setLoading(true);

            try {
                const response = await fetch('search.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, top_k: 10 })
                });

                if (!response.ok) {
                    let errorText = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorText;
                    } catch (e) {}
                    throw new Error(errorText);
                }

                const data = await response.json();
                renderResults(data, query);
            } catch (error) {
                console.error('Search error:', error);
                showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: ' + error.message);
                resultsContainer.innerHTML = '<div class="no-results">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ</div>';
            } finally {
                setLoading(false);
            }
        }

        searchBtn.addEventListener('click', (e) => {
            e.preventDefault();
            search(queryInput.value);
        });

        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchBtn.click();
            }
        });

        window.addEventListener('load', () => {
            queryInput.focus();
        });
    </script>
</body>
</html>
